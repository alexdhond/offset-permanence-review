---
title: "Permanence Risks"
author: "Alex Dhond"
date: "2025-06-13"
output:
  html_document:
    toc: true
    toc_float: true
---

## Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

library(tidyverse)
library(here)
library(readr)
library(ggplot2)
library(countrycode)
library(janitor)
library(forcats)
library(sf)
library(ggforce)
library(scatterpie)
library(rnaturalearth)
library(rnaturalearthdata)
```

## Create function to summarize by study
```{r}
summarize_by_study <- function(data, var, label = NULL) {
  var <- rlang::enquo(var)
  label <- label %||% rlang::as_name(var)

  data %>%
    filter(!is.na(!!var), !!var != "") %>%
    group_by(!!var) %>%
    summarise(n_studies = n_distinct(study_title), .groups = "drop") %>%
    arrange(desc(n_studies)) %>%
    rename(!!label := !!var)
}

```

Load dataset
```{r}
final_df <- read_csv(here("data", "derived", "offset_perm_rev_long_cleaned.csv")) %>%
  clean_names() %>%
  mutate(across(c(study_id, study_title), as.character))
```

Add continent information
```{r}
final_df <- final_df %>%
  mutate(continent = countrycode(country, origin = "country.name", destination = "continent")) %>%
  mutate(continent = case_when(
    is.na(continent) & str_detect(country, regex("Africa", ignore_case = TRUE))         ~ "Africa",
    is.na(continent) & str_detect(country, regex("Asia", ignore_case = TRUE))           ~ "Asia",
    is.na(continent) & str_detect(country, regex("Europe", ignore_case = TRUE))         ~ "Europe",
    is.na(continent) & str_detect(country, regex("Latin America", ignore_case = TRUE))  ~ "South America",
    is.na(continent) & str_detect(country, regex("European Union", ignore_case = TRUE)) ~ "Europe",
    TRUE ~ continent
  ))

```



#### Diving into permanence risks. what questions do I want to answer?

permanence risks
```{r}
summarize_by_study(final_df, permanence_risk_type, "Permanence Risk Type")

```

delivery types
```{r}
summarize_by_study(final_df, delivery_type, "Delivery Type")

```

policy types
```{r}
summarize_by_study(final_df, policy_type, "Policy Type")

```


ecosystems
```{r}
summarize_by_study(final_df, ecosystem_type)
summarize_by_study(final_df, ecosystem_broad_type)
```


species 
```{r}
summarize_by_study(final_df, species_common_name, "Species")

```

patterns by geographic region
```{r}
risk_by_continent <- final_df %>%
  filter(!is.na(permanence_risk_type), !is.na(continent)) %>%
  distinct(study_title, continent, permanence_risk_type) %>%
  count(continent, permanence_risk_type, name = "n")

ggplot(risk_by_continent, aes(x = fct_reorder(permanence_risk_type, n), y = n, fill = continent)) +
  geom_col(position = "dodge") +
  coord_flip() +
  facet_wrap(~ continent, scales = "free_y") +
  labs(
    title = "Most Common Permanence Risks by Continent",
    x = "Permanence Risk Type", y = "Number of Studies"
  ) +
  theme_minimal()

```

```{r}

risk_map_data <- final_df %>%
  filter(!is.na(permanence_risk_type), !is.na(country)) %>%
  distinct(study_title, country) %>%
  count(country, name = "n_risk_studies")

world <- ne_countries(scale = "medium", returnclass = "sf")

world_risks <- world %>%
  left_join(risk_map_data, by = c("name" = "country"))

ggplot(world_risks) +
  geom_sf(aes(fill = n_risk_studies), color = "white") +
  scale_fill_viridis_c(option = "plasma", na.value = "grey90") +
  labs(
    title = "Number of Studies with Permanence Risks by Country",
    fill = "Studies"
  ) +
  theme_minimal()

```
risks by continent
```{r}
dominant_risk_domain <- final_df %>%
  filter(!is.na(permanence_risk_domain), !is.na(continent)) %>%
  distinct(study_title, continent, permanence_risk_domain) %>%
  count(continent, permanence_risk_domain) %>%
  group_by(continent) %>%
  mutate(prop = n / sum(n))

ggplot(dominant_risk_domain, aes(x = continent, y = prop, fill = permanence_risk_domain)) +
  geom_col() +
  labs(
    title = "Permanence Risk Domains by Continent",
    y = "Proportion of Studies", x = "Continent", fill = "Risk Domain"
  ) +
  theme_minimal()

```


```{r}
# Load your cleaned dataset
final_df <- read_csv(here::here("data", "derived", "offset_perm_rev_long_cleaned.csv"))

# Add continent column
final_df <- final_df %>%
  mutate(continent = countrycode(country, origin = "country.name", destination = "continent")) %>%
  mutate(continent = case_when(
    is.na(continent) & str_detect(country, "Africa") ~ "Africa",
    is.na(continent) & str_detect(country, "Asia") ~ "Asia",
    is.na(continent) & str_detect(country, "Europe|European Union") ~ "Europe",
    is.na(continent) & str_detect(country, "Latin America") ~ "South America",
    TRUE ~ continent
  ))

# Count risk categories per continent
risk_by_continent <- final_df %>%
  filter(!is.na(permanence_risk_category), !is.na(continent)) %>%
  group_by(continent, permanence_risk_category) %>%
  summarise(n = n_distinct(study_title), .groups = "drop") %>%
  pivot_wider(names_from = permanence_risk_category, values_from = n, values_fill = 0)

```

```{r}
continent_coords <- tribble(
  ~continent,       ~lon, ~lat,
  "Africa",         20,    5,
  "Asia",          100,   40,
  "Europe",         10,   50,
  "North America", -100,  45,
  "South America", -60,  -15,
  "Oceania",       140,  -25
)

risk_by_continent <- left_join(continent_coords, risk_by_continent, by = "continent")

world <- ne_countries(scale = "medium", returnclass = "sf")

ggplot() +
  geom_sf(data = world, fill = "grey95", color = "white") +
  geom_scatterpie(
    aes(x = lon, y = lat),
    data = risk_by_continent,
    cols = setdiff(colnames(risk_by_continent), c("continent", "lon", "lat")),
    color = NA,
    alpha = 0.9
  ) +
  coord_sf() +
  labs(
    title = "Permanence Risk Categories by Continent",
    subtitle = "Pie size not scaled by total count for simplicity",
    fill = "Risk Category"
  ) +
  theme_minimal()

```

```{r}
category_domain_lookup <- final_df %>%
  select(permanence_risk_category, permanence_risk_domain) %>%
  distinct() %>%
  filter(!is.na(permanence_risk_category), !is.na(permanence_risk_domain))
risk_by_continent_long <- final_df %>%
  filter(!is.na(permanence_risk_category), !is.na(continent)) %>%
  count(continent, permanence_risk_category) %>%
  left_join(category_domain_lookup, by = "permanence_risk_category")


domain_colors <- c(
  "non-physical"   = "#E69F00",
  "methodological" = "#56B4E9",
  "physical"       = "#009E73"
)

category_colors <- risk_by_continent_long %>%
  distinct(permanence_risk_category, permanence_risk_domain) %>%
  mutate(color = domain_colors[permanence_risk_domain]) %>%
  deframe()  # named vector: category -> color

library(scatterpie)

risk_pie_data <- risk_by_continent_long %>%
  pivot_wider(
    names_from = permanence_risk_category,
    values_from = n,
    values_fill = 0
  ) %>%
  left_join(continent_coords, by = "continent")

# 2. Ensure all pie slice columns are numeric
pie_cols <- setdiff(names(risk_pie_data), c("continent", "lon", "lat"))

risk_pie_data <- risk_pie_data %>%
  mutate(across(all_of(pie_cols), as.numeric))


```

```{r}
ggplot() +
  geom_sf(data = world, fill = "grey95", color = "white") +
  geom_scatterpie(
    aes(x = lon, y = lat),
    data = risk_pie_data,
    cols = pie_cols,
    color = "white",
    pie_scale = 1
  ) +
  scale_fill_manual(
    values = category_colors,
    name = "Permanence Risk Category (by domain)"
  ) +
  coord_sf() +
  labs(
    title = "Permanence Risk Categories by Continent",
    subtitle = "Pie colors reflect their broader domain",
    x = NULL, y = NULL
  ) +
  theme_minimal()

```

